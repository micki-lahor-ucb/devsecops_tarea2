name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:

env:
  NODE_VERSION: "20"

jobs:
  devsecops:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            backend/users-service/package-lock.json
            backend/academic-service/package-lock.json
            backend/api-gateway/package-lock.json
            frontend/package-lock.json

      - name: Set versioned image tag
        run: echo "IMAGE_TAG=${GITHUB_SHA::12}" >> "$GITHUB_ENV"

      # 1) Instalacion reproducible
      - name: Install dependencies (users-service)
        run: |
          cd backend/users-service
          npm ci

      - name: Install dependencies (academic-service)
        run: |
          cd backend/academic-service
          npm ci

      - name: Install dependencies (api-gateway)
        run: |
          cd backend/api-gateway
          npm ci

      - name: Install dependencies (frontend)
        run: |
          cd frontend
          npm ci

      # 2) Calidad de codigo
      - name: Lint frontend source (ESLint)
        run: |
          cd frontend
          npx eslint "src/**/*.{js,jsx}"

      # 3) Testing automatico
      - name: Run tests (users-service)
        run: |
          cd backend/users-service
          npm test -- --runInBand

      - name: Run tests (academic-service)
        run: |
          cd backend/academic-service
          npm test -- --runInBand

      - name: Run tests (api-gateway)
        run: |
          cd backend/api-gateway
          npm test -- --runInBand

      - name: Run tests (frontend)
        run: |
          cd frontend
          npm test -- --runInBand

      # 4) SAST
      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: SAST scan (Semgrep)
        run: |
          semgrep --config=auto --severity=ERROR backend/users-service backend/academic-service backend/api-gateway frontend

      # 5) SCA dependencias
      - name: SCA scan (npm audit critical)
        run: |
          cd backend/users-service
          npm audit --audit-level=critical
          cd ../academic-service
          npm audit --audit-level=critical
          cd ../api-gateway
          npm audit --audit-level=critical
          cd ../../frontend
          npm audit --audit-level=critical

      - name: Create env files for Docker Compose
        run: |
          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          cp frontend/.env.example frontend/.env

      # 6) Build de contenedores con versionado
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (versioned + latest)
        run: |
          docker build -t users-service:${IMAGE_TAG} -t users-service:latest backend/users-service
          docker build -t academic-service:${IMAGE_TAG} -t academic-service:latest backend/academic-service
          docker build -t api-gateway:${IMAGE_TAG} -t api-gateway:latest backend/api-gateway
          docker build -t frontend:${IMAGE_TAG} -t frontend:latest frontend

      # 7) Seguridad de contenedores
      - name: Trivy scan users-service image
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: users-service:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: "1"
          vuln-type: "os,library"

      - name: Trivy scan academic-service image
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: academic-service:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: "1"
          vuln-type: "os,library"

      - name: Trivy scan api-gateway image
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: api-gateway:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: "1"
          vuln-type: "os,library"

      - name: Trivy scan frontend image
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: frontend:${{ env.IMAGE_TAG }}
          severity: CRITICAL
          exit-code: "1"
          vuln-type: "os,library"

      # 8) Smoke tests post deploy
      - name: Run docker-compose
        run: |
          docker compose -f backend/docker-compose.yml up -d --build
          sleep 15

      - name: Smoke test API Gateway
        run: |
          curl --fail http://localhost:3000/health

      - name: Shutdown services
        if: always()
        run: docker compose -f backend/docker-compose.yml down || true
